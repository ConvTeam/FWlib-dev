<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.3.1"/>
<title>WIZlib Library API: dns.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="wiznet_logo.jpg"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">WIZlib Library API
   &#160;<span id="projectnumber">ver 1.0</span>
   </div>
   <div id="projectbrief">WIZlib Library API User Menual</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.3.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">dns.c</div>  </div>
</div><!--header-->
<div class="contents">
<h1>DNS Examples</h1>
<hr/>
 <h2>TEST TEST DNS Query 1</h2>
<h3>Architecture(User's Guide)</h3>
<p>test <br/>
 test <br/>
 <br/>
<br/>
 <b>Usage</b> </p>
<div class="fragment"><div class="line">Usage: hello &lt;yourname&gt;</div>
</div><!-- fragment --><p> <br/>
 <b>Example</b> </p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;abc.h&quot;</span></div>
<div class="line">...</div>
<div class="line">void main() {</div>
<div class="line">...</div>
<div class="line">    <span class="keyword">set</span>();</div>
<div class="line">...</div>
<div class="line">}</div>
</div><!-- fragment --><p> <br/>
 </p>
<dl class="section see"><dt>See Also</dt><dd>main <br/>
<br/>
</dd></dl>
<hr/>
 <h2>TEST TEST DNS Query 2</h2>
<h3>Architecture(User's Guide)</h3>
<p>test <br/>
 test <br/>
 <br/>
<br/>
 <b>Usage</b> </p>
<div class="fragment"><div class="line">Usage: hello &lt;yourname&gt;</div>
</div><!-- fragment --><p> <br/>
 <b>Example</b> </p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;abc.h&quot;</span></div>
<div class="line">...</div>
<div class="line">void main() {</div>
<div class="line">...</div>
<div class="line">    <span class="keyword">set</span>();</div>
<div class="line">...</div>
<div class="line">}</div>
</div><!-- fragment --><p> <br/>
 </p>
<dl class="section see"><dt>See Also</dt><dd>main <br/>
<br/>
</dd></dl>
<hr/>
<p> <br/>
 </p>
<h3>Source Code</h3>
<div class="fragment"><div class="line"></div>
<div class="line"><span class="comment">//#define FILE_LOG_SILENCE</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="dns_8h.html" title="DNS Protocol Module Header File.">protocol/DNS/dns.h</a>&quot;</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define INITRTT     2000L   </span><span class="comment">/* Initial smoothed response time */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MAXCNAME    10  </span><span class="comment">/* Maximum amount of cname recursion */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define TYPE_A      1   </span><span class="comment">/* Host address */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define TYPE_NS     2   </span><span class="comment">/* Name server */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define TYPE_MD     3   </span><span class="comment">/* Mail destination (obsolete) */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define TYPE_MF     4   </span><span class="comment">/* Mail forwarder (obsolete) */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define TYPE_CNAME  5   </span><span class="comment">/* Canonical name */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define TYPE_SOA    6   </span><span class="comment">/* Start of Authority */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define TYPE_MB     7   </span><span class="comment">/* Mailbox name (experimental) */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define TYPE_MG     8   </span><span class="comment">/* Mail group member (experimental) */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define TYPE_MR     9   </span><span class="comment">/* Mail rename name (experimental) */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define TYPE_NULL   10  </span><span class="comment">/* Null (experimental) */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define TYPE_WKS    11  </span><span class="comment">/* Well-known sockets */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define TYPE_PTR    12  </span><span class="comment">/* Pointer record */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define TYPE_HINFO  13  </span><span class="comment">/* Host information */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define TYPE_MINFO  14  </span><span class="comment">/* Mailbox information (experimental)*/</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define TYPE_MX     15  </span><span class="comment">/* Mail exchanger */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define TYPE_TXT    16  </span><span class="comment">/* Text strings */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define TYPE_ANY    255 </span><span class="comment">/* Matches any type */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define CLASS_IN    1   </span><span class="comment">/* The ARPA Internet */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Round trip timing parameters */</span></div>
<div class="line"><span class="preprocessor">#define AGAIN   8       </span><span class="comment">/* Average RTT gain = 1/8 */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define LAGAIN  3       </span><span class="comment">/* Log2(AGAIN) */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define DGAIN   4       </span><span class="comment">/* Mean deviation gain = 1/4 */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define LDGAIN  2       </span><span class="comment">/* log2(DGAIN) */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define IPPORT_DOMAIN   53</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MAX_DNS_BUF_SIZE    512     </span><span class="comment">/* maximum size of DNS buffer. */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Header for all domain messages */</span></div>
<div class="line"><span class="keyword">struct </span>dhdr</div>
<div class="line">{</div>
<div class="line">    uint16 id;      <span class="comment">/* Identification */</span></div>
<div class="line">    uint8   qr;     <span class="comment">/* Query/Response */</span></div>
<div class="line"><span class="preprocessor">#define QUERY       0</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define RESPONSE    1</span></div>
<div class="line"><span class="preprocessor"></span>    uint8   opcode;</div>
<div class="line"><span class="preprocessor">#define IQUERY      1</span></div>
<div class="line"><span class="preprocessor"></span>    uint8   aa;     <span class="comment">/* Authoratative answer */</span></div>
<div class="line">    uint8   tc;     <span class="comment">/* Truncation */</span></div>
<div class="line">    uint8   rd;     <span class="comment">/* Recursion desired */</span></div>
<div class="line">    uint8   ra;     <span class="comment">/* Recursion available */</span></div>
<div class="line">    uint8   rcode;      <span class="comment">/* Response code */</span></div>
<div class="line"><span class="preprocessor">#define NO_ERROR    0</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define FORMAT_ERROR    1</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define SERVER_FAIL 2</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define NAME_ERROR  3</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define NOT_IMPL    4</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define REFUSED     5</span></div>
<div class="line"><span class="preprocessor"></span>    uint16 qdcount; <span class="comment">/* Question count */</span></div>
<div class="line">    uint16 ancount; <span class="comment">/* Answer count */</span></div>
<div class="line">    uint16 nscount; <span class="comment">/* Authority (name server) count */</span></div>
<div class="line">    uint16 arcount; <span class="comment">/* Additional record count */</span></div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> uint8 * put16(uint8 *s, uint16 i)</div>
<div class="line">{</div>
<div class="line">    *s++ = i &gt;&gt; 8;</div>
<div class="line">    *s++ = i;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> s;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> uint16 get16(uint8 *s)</div>
<div class="line">{</div>
<div class="line">    uint16 i;</div>
<div class="line"></div>
<div class="line">    i = *s++ &lt;&lt; 8;</div>
<div class="line">    i = i + *s;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> i;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> int16 dns_makequery(uint16 op, int8 *name, uint8 *buf, uint16 len)</div>
<div class="line">{</div>
<div class="line">    uint8 *cp;</div>
<div class="line">    int8 *cp1;</div>
<div class="line">    int8 sname[MAX_DNS_BUF_SIZE];</div>
<div class="line">    int8 *dname;</div>
<div class="line">    uint16 p;</div>
<div class="line">    uint16 dlen;</div>
<div class="line">    <span class="keyword">static</span> uint16 MSG_ID = 0x1122;</div>
<div class="line"></div>
<div class="line">    cp = buf;</div>
<div class="line"></div>
<div class="line">    MSG_ID++;</div>
<div class="line">    cp = put16(cp, MSG_ID);</div>
<div class="line">    p = (op &lt;&lt; 11) | 0x0100;            <span class="comment">/* Recursion desired */</span></div>
<div class="line">    cp = put16(cp, p);</div>
<div class="line">    cp = put16(cp, 1);</div>
<div class="line">    cp = put16(cp, 0);</div>
<div class="line">    cp = put16(cp, 0);</div>
<div class="line">    cp = put16(cp, 0);</div>
<div class="line"></div>
<div class="line">    strcpy((<span class="keywordtype">char</span>*)sname, (<span class="keywordtype">char</span>*)name);</div>
<div class="line">    dname = sname;</div>
<div class="line">    dlen = strlen((<span class="keywordtype">char</span>*)dname);</div>
<div class="line">    <span class="keywordflow">for</span> (;;)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">/* Look for next dot */</span></div>
<div class="line">        cp1 = (int8*)strchr((<span class="keywordtype">char</span>*)dname, <span class="charliteral">&#39;.&#39;</span>);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (cp1 != NULL) len = cp1 - dname; <span class="comment">/* More to come */</span></div>
<div class="line">        <span class="keywordflow">else</span> len = dlen;            <span class="comment">/* Last component */</span></div>
<div class="line"></div>
<div class="line">        *cp++ = len;                <span class="comment">/* Write length of component */</span></div>
<div class="line">        <span class="keywordflow">if</span> (len == 0) <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Copy component up to (but not including) dot */</span></div>
<div class="line">        strncpy((<span class="keywordtype">char</span>*)cp, (<span class="keywordtype">char</span>*)dname, len);</div>
<div class="line">        cp += len;</div>
<div class="line">        <span class="keywordflow">if</span> (cp1 == NULL)</div>
<div class="line">        {</div>
<div class="line">            *cp++ = 0;          <span class="comment">/* Last one; write null and finish */</span></div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">        dname += len+1;</div>
<div class="line">        dlen -= len+1;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    cp = put16(cp, 0x0001);             <span class="comment">/* type */</span></div>
<div class="line">    cp = put16(cp, 0x0001);             <span class="comment">/* class */</span></div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> ((int16)(cp - buf));</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> int32 parse_name(uint8 *msg, uint8 *compressed, int8 *buf, int16 len)</div>
<div class="line">{</div>
<div class="line">    uint16 slen;        <span class="comment">/* Length of current segment */</span></div>
<div class="line">    uint8 * cp;</div>
<div class="line">    int32 clen = 0;     <span class="comment">/* Total length of compressed name */</span></div>
<div class="line">    int32 indirect = 0; <span class="comment">/* Set if indirection encountered */</span></div>
<div class="line">    int32 nseg = 0;     <span class="comment">/* Total number of segments in name */</span></div>
<div class="line"></div>
<div class="line">    cp = compressed;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (;;)</div>
<div class="line">    {</div>
<div class="line">        slen = *cp++;   <span class="comment">/* Length of this segment */</span></div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (!indirect) clen++;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> ((slen &amp; 0xc0) == 0xc0)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">if</span> (!indirect)</div>
<div class="line">                clen++;</div>
<div class="line">            indirect = 1;</div>
<div class="line">            <span class="comment">/* Follow indirection */</span></div>
<div class="line">            cp = &amp;msg[((slen &amp; 0x3f)&lt;&lt;8) + *cp];</div>
<div class="line">            slen = *cp++;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (slen == 0)  <span class="comment">/* zero length == all done */</span></div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">        len -= slen + 1;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (len &lt; 0) <span class="keywordflow">return</span> -1;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (!indirect) clen += slen;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">while</span> (slen-- != 0) *buf++ = (int8)*cp++;</div>
<div class="line">        *buf++ = <span class="charliteral">&#39;.&#39;</span>;</div>
<div class="line">        nseg++;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (nseg == 0)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">/* Root name; represent as single dot */</span></div>
<div class="line">        *buf++ = <span class="charliteral">&#39;.&#39;</span>;</div>
<div class="line">        len--;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    *buf++ = <span class="charliteral">&#39;\0&#39;</span>;</div>
<div class="line">    len--;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> clen;    <span class="comment">/* Length of compressed message */</span></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> uint8 * dns_question(uint8 *msg, uint8 *cp)</div>
<div class="line">{</div>
<div class="line">    int32 len;</div>
<div class="line">    int8 name[MAX_DNS_BUF_SIZE];</div>
<div class="line"></div>
<div class="line">    len = parse_name(msg, cp, name, MAX_DNS_BUF_SIZE);</div>
<div class="line"></div>
<div class="line">    <a name="a0"></a><a class="code" href="common_8h.html#a0325ae6233a5c48c889ce3c7fdaef0d5" title="Print Error Log with parameter (+CRLF).">DBGA</a>(<span class="stringliteral">&quot;dns_question : %s&quot;</span>, name);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (len == -1) <span class="keywordflow">return</span> 0;</div>
<div class="line"></div>
<div class="line">    cp += len;</div>
<div class="line">    cp += 2;        <span class="comment">/* type */</span></div>
<div class="line">    cp += 2;        <span class="comment">/* class */</span></div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> cp;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> uint8 * dns_answer(uint8 *msg, uint8 *cp, uint8 *pSip)</div>
<div class="line">{</div>
<div class="line">    int32 len, type;</div>
<div class="line">    int8 name[MAX_DNS_BUF_SIZE];</div>
<div class="line"></div>
<div class="line">    len = parse_name(msg, cp, name, MAX_DNS_BUF_SIZE);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (len == -1) <span class="keywordflow">return</span> 0;</div>
<div class="line"></div>
<div class="line">    cp += len;</div>
<div class="line">    type = get16(cp);</div>
<div class="line">    cp += 2;        <span class="comment">/* type */</span></div>
<div class="line">    cp += 2;        <span class="comment">/* class */</span></div>
<div class="line">    cp += 4;        <span class="comment">/* ttl */</span></div>
<div class="line">    cp += 2;        <span class="comment">/* len */</span></div>
<div class="line"></div>
<div class="line">    <a class="code" href="common_8h.html#a0325ae6233a5c48c889ce3c7fdaef0d5" title="Print Error Log with parameter (+CRLF).">DBGA</a>(<span class="stringliteral">&quot;dns_answer : %s : %u : %.4x&quot;</span>, name, len, type);</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">switch</span> (type)</div>
<div class="line">    {</div>
<div class="line">    <span class="keywordflow">case</span> TYPE_A:</div>
<div class="line">        <span class="comment">/* Just read the address directly into the structure */</span></div>
<div class="line">        <span class="comment">//Server_IP_Addr[0] = *cp++;</span></div>
<div class="line">        <span class="comment">//Server_IP_Addr[1] = *cp++;</span></div>
<div class="line">        <span class="comment">//Server_IP_Addr[2] = *cp++;</span></div>
<div class="line">        <span class="comment">//Server_IP_Addr[3] = *cp++;</span></div>
<div class="line">        <span class="comment">//Config_Msg.Sip[0] = *cp++;</span></div>
<div class="line">        <span class="comment">//Config_Msg.Sip[1] = *cp++;</span></div>
<div class="line">        <span class="comment">//Config_Msg.Sip[2] = *cp++;</span></div>
<div class="line">        <span class="comment">//Config_Msg.Sip[3] = *cp++;</span></div>
<div class="line">        pSip[0] = *cp++;</div>
<div class="line">        pSip[1] = *cp++;</div>
<div class="line">        pSip[2] = *cp++;</div>
<div class="line">        pSip[3] = *cp++;</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> TYPE_CNAME:</div>
<div class="line">    <span class="keywordflow">case</span> TYPE_MB:</div>
<div class="line">    <span class="keywordflow">case</span> TYPE_MG:</div>
<div class="line">    <span class="keywordflow">case</span> TYPE_MR:</div>
<div class="line">    <span class="keywordflow">case</span> TYPE_NS:</div>
<div class="line">    <span class="keywordflow">case</span> TYPE_PTR:</div>
<div class="line">        <span class="comment">/* These types all consist of a single domain name */</span></div>
<div class="line">        <span class="comment">/* convert it to ascii format */</span></div>
<div class="line">        len = parse_name(msg, cp, name, MAX_DNS_BUF_SIZE);</div>
<div class="line">        <span class="keywordflow">if</span> (len == -1) <span class="keywordflow">return</span> 0;</div>
<div class="line"></div>
<div class="line">        cp += len;</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> TYPE_HINFO:</div>
<div class="line">        len = *cp++;</div>
<div class="line">        cp += len;</div>
<div class="line"></div>
<div class="line">        len = *cp++;</div>
<div class="line">        cp += len;</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> TYPE_MX:</div>
<div class="line">        cp += 2;</div>
<div class="line">        <span class="comment">/* Get domain name of exchanger */</span></div>
<div class="line">        len = parse_name(msg, cp, name, MAX_DNS_BUF_SIZE);</div>
<div class="line">        <span class="keywordflow">if</span> (len == -1) <span class="keywordflow">return</span> 0;</div>
<div class="line"></div>
<div class="line">        cp += len;</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> TYPE_SOA:</div>
<div class="line">        <span class="comment">/* Get domain name of name server */</span></div>
<div class="line">        len = parse_name(msg, cp, name, MAX_DNS_BUF_SIZE);</div>
<div class="line">        <span class="keywordflow">if</span> (len == -1) <span class="keywordflow">return</span> 0;</div>
<div class="line"></div>
<div class="line">        cp += len;</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Get domain name of responsible person */</span></div>
<div class="line">        len = parse_name(msg, cp, name, MAX_DNS_BUF_SIZE);</div>
<div class="line">        <span class="keywordflow">if</span> (len == -1) <span class="keywordflow">return</span> 0;</div>
<div class="line"></div>
<div class="line">        cp += len;</div>
<div class="line"></div>
<div class="line">        cp += 4;</div>
<div class="line">        cp += 4;</div>
<div class="line">        cp += 4;</div>
<div class="line">        cp += 4;</div>
<div class="line">        cp += 4;</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> TYPE_TXT:</div>
<div class="line">        <span class="comment">/* Just stash */</span></div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">default</span>:</div>
<div class="line">        <span class="comment">/* Ignore */</span></div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> cp;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> int8 parseMSG(<span class="keyword">struct</span> dhdr *pdhdr, uint8 *pbuf, uint8 *pSip)</div>
<div class="line">{</div>
<div class="line">    uint16 tmp;</div>
<div class="line">    uint16 i;</div>
<div class="line">    uint8 * msg;</div>
<div class="line">    uint8 * cp;</div>
<div class="line"></div>
<div class="line">    msg = pbuf;</div>
<div class="line">    memset(pdhdr, 0, <span class="keyword">sizeof</span>(pdhdr));</div>
<div class="line"></div>
<div class="line">    pdhdr-&gt;id = get16(&amp;msg[0]);</div>
<div class="line">    tmp = get16(&amp;msg[2]);</div>
<div class="line">    <span class="keywordflow">if</span> (tmp &amp; 0x8000) pdhdr-&gt;qr = 1;</div>
<div class="line"></div>
<div class="line">    pdhdr-&gt;opcode = (tmp &gt;&gt; 11) &amp; 0xf;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (tmp &amp; 0x0400) pdhdr-&gt;aa = 1;</div>
<div class="line">    <span class="keywordflow">if</span> (tmp &amp; 0x0200) pdhdr-&gt;tc = 1;</div>
<div class="line">    <span class="keywordflow">if</span> (tmp &amp; 0x0100) pdhdr-&gt;rd = 1;</div>
<div class="line">    <span class="keywordflow">if</span> (tmp &amp; 0x0080) pdhdr-&gt;ra = 1;</div>
<div class="line"></div>
<div class="line">    pdhdr-&gt;rcode = tmp &amp; 0xf;</div>
<div class="line">    pdhdr-&gt;qdcount = get16(&amp;msg[4]);</div>
<div class="line">    pdhdr-&gt;ancount = get16(&amp;msg[6]);</div>
<div class="line">    pdhdr-&gt;nscount = get16(&amp;msg[8]);</div>
<div class="line">    pdhdr-&gt;arcount = get16(&amp;msg[10]);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="common_8h.html#a0325ae6233a5c48c889ce3c7fdaef0d5" title="Print Error Log with parameter (+CRLF).">DBGA</a>(<span class="stringliteral">&quot;dhdr-&gt;qdcount : %x&quot;</span>, (uint16)pdhdr-&gt;qdcount);</div>
<div class="line">    <a class="code" href="common_8h.html#a0325ae6233a5c48c889ce3c7fdaef0d5" title="Print Error Log with parameter (+CRLF).">DBGA</a>(<span class="stringliteral">&quot;dhdr-&gt;ancount : %x&quot;</span>, (uint16)pdhdr-&gt;ancount);</div>
<div class="line">    <a class="code" href="common_8h.html#a0325ae6233a5c48c889ce3c7fdaef0d5" title="Print Error Log with parameter (+CRLF).">DBGA</a>(<span class="stringliteral">&quot;dhdr-&gt;nscount : %x&quot;</span>, (uint16)pdhdr-&gt;nscount);</div>
<div class="line">    <a class="code" href="common_8h.html#a0325ae6233a5c48c889ce3c7fdaef0d5" title="Print Error Log with parameter (+CRLF).">DBGA</a>(<span class="stringliteral">&quot;dhdr-&gt;arcount : %x&quot;</span>, (uint16)pdhdr-&gt;arcount);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Now parse the variable length sections */</span></div>
<div class="line">    cp = &amp;msg[12];</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Question section */</span></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; pdhdr-&gt;qdcount; i++)</div>
<div class="line">    {</div>
<div class="line">        cp = dns_question(msg, cp);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Answer section */</span></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; pdhdr-&gt;ancount; i++)</div>
<div class="line">    {</div>
<div class="line">        cp = dns_answer(msg, cp, pSip);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Name server (authority) section */</span></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; pdhdr-&gt;nscount; i++)</div>
<div class="line">    {</div>
<div class="line">        ;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Additional section */</span></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; pdhdr-&gt;arcount; i++)</div>
<div class="line">    {</div>
<div class="line">        ;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span>(pdhdr-&gt;rcode == 0) <span class="keywordflow">return</span> <a name="a1"></a><a class="code" href="types_8h.html#a76117585e8ddc62f21ca0e3061b7830e" title="Success return value.">RET_OK</a>;</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">return</span> <a name="a2"></a><a class="code" href="types_8h.html#a99e73667f3ffd6ea8c3a732a82dc3116" title="Error return value.">RET_NOK</a>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">int8 <a name="a3"></a><a class="code" href="group__dns__module.html#gac42982cd854842ec3eb003e199056fb7" title="Perform DNS Query.">dns_query</a>(uint8 sock, uint8 *domain, uint8 *ip)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>dhdr dhp;</div>
<div class="line">    <a name="_a4"></a><a class="code" href="structwiz___net_info__t.html" title="Common Network Information Structure.">wiz_NetInfo</a> netinfo;</div>
<div class="line">    uint8 ip_tmp[4], i = 0;</div>
<div class="line">    uint16 port;</div>
<div class="line">    int32 len, cnt;</div>
<div class="line">    uint32 tick;</div>
<div class="line">    <span class="keyword">static</span> uint8 dns_buf[MAX_DNS_BUF_SIZE];</div>
<div class="line"></div>
<div class="line">    tick = <a name="a5"></a><a class="code" href="group__platform__util__module.html#gafde0d91fa5ac52d0d45b9aaf6170f7a8" title="Get current SysTick.">wizpf_get_systick</a>();</div>
<div class="line">    srand(tick);</div>
<div class="line">    <span class="keywordflow">while</span>(<a name="a6"></a><a class="code" href="group__socket__module.html#ga3e6b2faaff8da10b841683b65c1e99c2" title="Open a UDP socket.">UDPOpen</a>(sock, rand() % 5535 + 60000) != <a class="code" href="types_8h.html#a76117585e8ddc62f21ca0e3061b7830e" title="Success return value.">RET_OK</a>) {</div>
<div class="line">        <span class="keywordflow">if</span>(i++ &gt; 3) {</div>
<div class="line">            <a class="code" href="common_8h.html#a0325ae6233a5c48c889ce3c7fdaef0d5" title="Print Error Log with parameter (+CRLF).">DBGA</a>(<span class="stringliteral">&quot;UDPOpen fail (%d)times&quot;</span>, i);</div>
<div class="line">            <span class="keywordflow">return</span> <a class="code" href="types_8h.html#a99e73667f3ffd6ea8c3a732a82dc3116" title="Error return value.">RET_NOK</a>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    i = 0;</div>
<div class="line">    <a name="a7"></a><a class="code" href="group__netdev__con__module.html#ga7206ee996c7f41981aa8329e799100df" title="This function get the network information.">GetNetInfo</a>(&amp;netinfo);</div>
<div class="line">    len = dns_makequery(0, (int8 *)domain, dns_buf, MAX_DNS_BUF_SIZE);</div>
<div class="line">    <span class="keywordflow">while</span>((cnt = <a name="a8"></a><a class="code" href="group__socket__module.html#gaba0b9cf9345389939e6008d34511b09c" title="Send the data in UDP mode.">UDPSend</a>(sock, (int8*)dns_buf, len, netinfo.dns, IPPORT_DOMAIN)) &lt; 0) {</div>
<div class="line">        <span class="keywordflow">if</span>(i++ &gt; 3) {</div>
<div class="line">            <a class="code" href="common_8h.html#a0325ae6233a5c48c889ce3c7fdaef0d5" title="Print Error Log with parameter (+CRLF).">DBGA</a>(<span class="stringliteral">&quot;UDPSend fail (%d)times&quot;</span>, i);</div>
<div class="line">            <span class="keywordflow">return</span> <a class="code" href="types_8h.html#a99e73667f3ffd6ea8c3a732a82dc3116" title="Error return value.">RET_NOK</a>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (cnt == 0) <span class="keywordflow">return</span> <a class="code" href="types_8h.html#a99e73667f3ffd6ea8c3a732a82dc3116" title="Error return value.">RET_NOK</a>; <span class="comment">// dns fail</span></div>
<div class="line"></div>
<div class="line">    cnt = 0;</div>
<div class="line">    <span class="keywordflow">while</span>(1) {</div>
<div class="line">        <span class="keywordflow">if</span>((len = <a name="a9"></a><a class="code" href="group__socket__module.html#gafbbebe2c65cbdf240c31a0fd524da725" title="Receive the data in UDP mode.">UDPRecv</a>(sock, (int8*)dns_buf, MAX_DNS_BUF_SIZE, ip_tmp, &amp;port)) &gt; 0) {</div>
<div class="line">            <a name="a10"></a><a class="code" href="group__socket__module.html#ga13b46600b8f897546dc27dbdbfe47e41" title="Close a UDP socket.">UDPClose</a>(sock);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">        <a name="a11"></a><a class="code" href="group__platform__util__module.html#ga3779de80181ef3606d44cf54d26fdff0" title="Mili-second Scale Delay Function.">Delay_ms</a>(10);</div>
<div class="line">        <span class="keywordflow">if</span>(cnt++ == 100) {</div>
<div class="line">            <a class="code" href="group__socket__module.html#ga13b46600b8f897546dc27dbdbfe47e41" title="Close a UDP socket.">UDPClose</a>(sock);</div>
<div class="line">            <span class="keywordflow">return</span> <a class="code" href="types_8h.html#a99e73667f3ffd6ea8c3a732a82dc3116" title="Error return value.">RET_NOK</a>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> parseMSG(&amp;dhp, dns_buf, ip); <span class="comment">/* Convert to local format */</span></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
</div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sun Mar 10 2013 15:02:25 for WIZlib Library API by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.3.1
</small></address>
</body>
</html>
